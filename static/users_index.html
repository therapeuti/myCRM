<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 목록</title>
    <link rel="stylesheet" href="/static/css/users.css">
</head>
<body>
    <nav>
        <a class="nav_link" href="/">Login</a>
        <a class="nav_link" href="/users" data-section="users">Users</a>
        <a class="nav_link" href="/stores">Stores</a>
        <a class="nav_link" href="/orders">Orders</a>
        <a class="nav_link" href="/items">Items</a>
        <a class="nav_link" href="/orderitems">Orderitems</a>
    </nav>
    <hr>
    <div id="container">
        <h1>사용자 목록</h1>
        <form>
            <div id="search">
                <select id="search_field">
                    <option value="id" selected>ID</option>
                    <option value="name">Name</option>
                    <option value="address">Address</option>
                </select>
                <input type="text" id="input_query" placeholder="검색어 입력">
                <select id="gender" name="gender">
                    <option value="">성별 선택</option>
                    <option value="Female">Female</option>
                    <option value="Male">Male</option>
                </select>
                <button type="submit" id="submit">검색</button>
            </div>
            <div id="order_by">
                <label> 정렬기준
                    <select id="orderby" name="orderby">
                        <option value="id">ID</option>
                        <option value="name" selected>Name</option>
                        <option value="birthdate">Birthdate</option>
                        <option value="age">Age</option>
                        <option value="gender">Gender</option>
                        <option value="address">Address</option>
                    </select>
                </label>
            </div>
        </form>
        <table id="user_table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Birthdate</th>
                <th>Age</th>
                <th>Gender</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <!-- 사용자 정보 뜨는 곳 -->
        </tbody>
        
    </table>
    <p class="comment"></p>
    </div>
    <div id="btn-container">
        <div class="page-btn">
            <button id="start_page">처음</button>
            <button id="prev10">-10</button>
            <button id="previous">이전</button>
        </div>
        <div id="pagination">
            <!-- 페이지 번호 뜨는 곳 -->
        </div>
        <div class="page-btn">
            <button id="next">다음</button>
            <button id="next10">+10</button>
            <button id="end_page">끝</button>
        </div>
    </div>
            
        
    <script>
        const current_path = window.location.pathname;
        const search_field = document.getElementById('search_field');
        const input_query = document.getElementById('input_query');
        const submit = document.getElementById('submit');
        const gender = document.getElementById('gender');
        const orderby = document.getElementById('orderby');

        let section = current_path.split('/')[1];
        console.log(current_path)
        console.log(current_path.split('/'))
        const links = document.querySelectorAll('.nav_link');
        links.forEach(link => {
            const link_section = link.getAttribute('data-section')
            if (link_section === section){
                link.classList.add('active')
            }
        })

        input_query.name = search_field.value
        // search field 바뀜에 따라.. input_query가 바뀌도록... 이벤트 리스너 등록 필요...?
        search_field.addEventListener('change', (e)=>{
            input_query.name = e.target.value;
            console.log(input_query.name);
        })
        
        // 검색어 유지
        const parameters = new URLSearchParams(window.location.search);
        console.log(parameters.get('name'))
        console.log(parameters.get('id'))
        console.log(parameters.get('address'))
        console.log(parameters.get('gender'))
        if (parameters.get('id')) {
            search_field.value = 'id'
            input_query.value = parameters.get('id')}
        if (parameters.get('name')) {
            search_field.value = 'name'
            input_query.value = parameters.get('name')}
        if (parameters.get('address')) {
            search_field.value = 'address'
            input_query.value = parameters.get('address')}
        if (parameters.get('gender')) {
            gender.value = parameters.get('gender')}
        if (parameters.get('orderby')) {
            orderby.value = parameters.get('orderby')}

        // 폼 제출 경로 변경
        submit.addEventListener('click', (e)=>{
            // e.preventDefault();
            input_query.name = search_field.value
        })

        // 정렬 이벤트 리스너 
        orderby.addEventListener('change', (e)=>{
            console.log(e.target.value)
            const query = new URL(window.location);
            query.searchParams.set('orderby', e.target.value)
            console.log(query)
            window.location.href = query
            const current_page = get_current_page()
            change_page(1, true)

        })

        const user_list = document.getElementById('tbody')
        const pages = document.getElementById('pagination')
        const prev = document.getElementById('previous')
        const prev10 = document.getElementById('prev10')
        const next = document.getElementById('next')
        const next10 = document.getElementById('next10')
        
        document.getElementById('start_page').addEventListener('click', ()=>{
            change_page(1)
        })
        document.getElementById('end_page').addEventListener('click', ()=>{
            console.log('마지막 페이지 버튼 누름')
            // const current_page = get_current_page()
            // console.log(current_page)
            fetch_get_data()
                .then(data =>{
                    const end = data.total_pages
                    // console.log('도대체 왜때문이냐??? ',end)
                    change_page(end)
                })
        })
        prev.addEventListener('click', ()=>{
            const current_page = get_current_page()
            change_page(current_page - 1)
        })
        prev10.addEventListener('click', ()=>{
            const current_page = get_current_page()
            change_page(current_page - 10)
        })
        next.addEventListener('click', ()=>{
            const current_page = get_current_page()
            change_page(current_page + 1)
        })
        next10.addEventListener('click', ()=>{
            const current_page = get_current_page()
            change_page(current_page + 10)
        })
        
        // 페이지버튼 부모요소에 이벤트 리스너 등록하기
        pages.addEventListener('click', function(e){
            console.log('페이지 버튼에 이벤트 리스너 실행')
            // console.log(e)
            // 페이지 버튼 요소 각각에 클릭 이벤트 등록하기
            if (e.target.tagName == 'BUTTON'){
                console.log(e.target.textContent)
                const page = e.target.textContent
                change_page(Number(page))
            }
        })

        window.onpopstate = function(e) {
            console.log('뒤로가기 또는 앞으로 가기: ', e.state)
            const page = e.state?.page || get_current_page()
            change_page(page, false) // false는 url을 다시 pusthState로 기록하지 않기 위함.
        }

        // 현재 페이지 가져오는 함수
        function get_current_page() {
            const params = new URLSearchParams(window.location.search)
            console.log('------------------------------------')
            console.log('현재 페이지 가져오는 함수 실행: ', params)
            // console.log(params.get('page'))
            let current_page = params.get('page')
            console.log('현재 페이지는? ', current_page)
            if (!current_page || isNaN(current_page)){ // current_page가 빈값(Null)이거나 숫자가 아닌 경우(isNaN)
                current_page = 1
                console.log('현재 페이지 없으면 1 ', current_page)
                return Number(current_page)
            }
            // console.log(current_page)
            // console.log(typeof(current_page))
            return Number(current_page)
        }
        
        // 사용자 목록 렌더링하는 함수
        function render_users(users) {
            console.log('------------------------------------')

            console.log('render_users 함수 실행')
            console.log('사용자 데이터 수: ', users.length)
            user_list.innerHTML = '' // 사용자 목록 초기화
            if (users.length == 0) {
                document.getElementById('comment').textContent = "검색 조건에 해당하는 사용자를 찾을 수 없습니다."
            } else {
                const new_tr = document.createElement('tr')
                const cells = [{
                    tag:
                }]

                for (u of users) {
                    // console.log(u)
                    new_tr.innerHTML = `<td><a href="/users/info/${u.id}">${u.id}</a></td>
                                        <td>${u.name}</td>
                                        <td>${u.birthdate}</td>
                                        <td>${u.age}</td>
                                        <td>${u.gender}</td>
                                        <td>${u.address}</td>`
                    user_list.appendChild(new_tr)
                }
            }
        }
        
        // 페이지 버튼 렌더링하는 함수 => 10개 다 렌더링할 필요가 없는 경우...?
        function render_page_btns(end) {
            console.log('------------------------------------')
            console.log('render_page_btns 함수 실행')
            // console.log('end page: ', end)
            // console.log(typeof(end))
            current_page = get_current_page()

            // 이전/다음 버튼 비활성화 여부
            if (current_page == end) {
                next.disabled = true;
            } else {
                next.disabled = false;
            }
            if (current_page == 1){
                prev.disabled = true;
            } else {
                prev.disabled = false;
            }
            if (current_page <= 10){
                prev10.disabled = true;
            } else {
                prev10.disabled = false;
            }
            if (Math.floor((current_page-1)/10) == Math.floor((end-1)/10)) {
                next10.disabled = true;
            } else {
                next10.disabled = false;
            }

            // 현재 페이지와... 마지막 페이지.. 간의... 관계...? 고려...
            // 출력할 페이지 번호들 계산
            num = 10 // 한 페이지에 보여줄 페이지 버튼 수
            // console.log(typeof(current_page))
            const first_page = Math.floor((current_page - 1) / num )*num + 1
            const tenth_page = Math.floor((current_page - 1) / num)*num + num
            // console.log('첫번째 페이지: ', first_page)
            // console.log('열번째 페이지: ', tenth_page)
            const end_page_first = Math.floor((end - 1) / num)*num + 1
            // console.log('마지막의 첫번째 페이지: ', end_page_first)
            pages.innerHTML = '' // 페이지 번호 초기화
            if (first_page === end_page_first) {
                console.log('if문 들어왔니?')
                for (let page = end_page_first; page <= end; page++) {
                    // console.log('페이지 버튼이 왜 안 만들어지니?')
                    const pagelink = document.createElement('button')
                    pagelink.textContent = page
                    pagelink.setAttribute('data-page', page)
                    pages.appendChild(pagelink)
                    if (page == current_page) {
                        pagelink.classList.add('active')
                    }
                }
            } else {
                // console.log('else문 들어왔니?')
                for (let page = first_page; page <= tenth_page; page++) {
                    // console.log(page)
                    const pagelink = document.createElement('button')
                    pagelink.textContent = page
                    pagelink.setAttribute('data-page', page)
                    pages.appendChild(pagelink)
                    if (page == current_page) {
                        pagelink.classList.add('active')
                    }
                }
            }
        }
        
        function fetch_get_data() {
            console.log('------------------------------')
            console.log('fetch 함수 실행됨')
            const params = new URLSearchParams(window.location.search)
            const current_page = params.get('page')
            const id = params.get('id')
            const name = params.get('name')
            const address = params.get('address')
            const gender = params.get('gender')
            const orderby = params.get('orderby')

            const query = new URLSearchParams()
            if (id) {query.set('id', id)}
            if (name) {query.set('name', name)}
            if (address) {query.set('address', address)}
            if (gender) {query.set('gender', gender)}
            if (current_page) {query.set('page', current_page)}
            if (orderby) {query.set('orderby', orderby)}
            console.log('쿼리 내용: ', query)

            return fetch(`/api/users/?${query.toString()}`) // blueprint 사용시 fetch경로
                .then(response => response.json())
        }
        
        function render_page(data) {   
                console.log('-------------------------------------------------')
                console.log('render_page 실행')
                // console.log(data.users[0])
                console.log('전체 페이지 수: ', data.total_pages)
                // console.log('데이터 가져왔니?')
                // console.log(typeof(current_page))
                // console.log('현재 페이지: ', current_page)
                // console.log('이전 페이지: ', current_page - 1)
                // console.log('다음 페이지: ', current_page + 1)
                // console.log('마지막 페이지: ', data.total_pages)
                const users  = data.users
                // console.log('사용자 데이터 받아왔니?', users)
                const end_pages = data.total_pages
                // console.log('end page: ', end_pages)
                // console.log(typeof(end_pages))
                // 사용자 목록 렌더링
                render_users(users)
                // 페이지 번호 렌더링
                render_page_btns(end_pages)
                
        }

        function change_page(page, pushState=true) {
            console.log('---------------------------------------------')
            console.log('페이지 변경')

            // url 변경(history.pushState 사용)
            if (pushState) {
                const url = new URL(window.location);
                url.searchParams.set('page', page);
                history.pushState({page: page}, '', url);
                }
            fetch_get_data()
                .then(data => {
                    render_page(data)
                    console.log(search_field.value) // 검색 후에 value값은 남아있긴 한데.. 다시 검색 누르면 value값 날아감.
                    console.log(input_query.value)

                })
        }


        // 사용자 id 클릭하면 해당 아이디 정보를 서버로 보내...? url통해서...?
        // 그럼 서버에서 아이디로 정보 찾아서 클라이언트로 보냄....

        function init() {
            console.log('init이 따로 필요할까....?--------------')
            const current_page = get_current_page()
            change_page(current_page, false)
            }
        
        init()
    </script>
</body>
</html>